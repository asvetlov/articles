Мы с быком пахали


На самом деле я давно верил в успех библиотек для неблокироющего
ввода-вывода на генераторах, но к разработке asyncio (тогда еще tulip)
присоединился не сразу.

Наблюдал с любопытством за письмами в рассылке, учил людей основываясь
на tulip коде (он выглядел уже тогда как наиболее простой демонстратор технологии
по сравнению с twisted и tornado).

В 2013 на PyCon US Гвидо ван Россум презеновал tulip как
проект будущего сетевого программированя на Python.

Тогда было два разработчика: ван Россум и Николай Ким (по словам Гвидо
"сумашедший русский, вложивший много сил в tulip и которому я очень
благодарен").

Я сделал первые правки в tulip на Sprints той конференции: что-то
починил и стал работать над Unix PIPES и запуском процессов
(subprocess) в tulip.

Потом много воды утекло, tulip стал называться asyncio. Вышел Python
3.4 c asyncio "из коробки".

Большое спасибо Victor Stinner: он написал документацию, сделал кучу
мелких улучшений для поиска багов, много маленьких но необходимых
правок -- и в результате библиотека получилась.

Извините, люди, помогавшие в создании asyncio, но не попавшие в
список: я вас всех помню и ценю.


-----------------------------

Итак, ситуация на зиму 2014.

asyncio в целом завершен и готов к выпуску.

Имеем сокеты, unix sockets, unix pipes, subprocesses.

Весь этот список почти бесполезен для "простого программиста": ему
нужны базы данных и web сервера.

Но основа хорошая -- нужно только лишь построить правильные библиотеки
поверх нового богатства.

------------------------
О всяких базах данных чуть позже, сейчас об aiohttp

-----------------------------------------------

Коля Ким начал писать asyncio http летом 2013, но его код был спорным,
нестабильным в смысле проработанного API и вообще неготовым к
включению в Python Standard Library.

И это хорошо.

Ким вырезал http код из asyncio и опубликовал его как aiohttp.

Там уже было самое важное: HTTP protocol, websockets, HTTP client/server.

Всё это счастье было впрочем, весьма нелегко использовать -- нужно
было знать в деталях как работает HTTP protocol чтобы понять, что я
сделал не так.

Но, еще раз повторюсь, хорошая основа уже была заложена.

--------------------------------------------------------

Так случилось, что в марте 2014 я пришел на новую работу.

И мне повезло в том, что я мог выбирать технологию.

Вдвойне повезло, что рядом со мной оказался Алексей Поправка -- вместе
с ним мы сделали aiorest тогда и продолжаем работать бок-о-бок теперь.


---------------------------------------------------------

Ситуация: мы верим в asyncio но библиотек нет совсем.

Есть aiohttp но шаг влево-вправо -- кошмар, мы не понимаем почему оно
выбрасывает совершенно непонятные исключения когда должно просто
работать. Извини, Ким, так было. И с клиентом и с сервером.


Нам тогда был нужен только REST через JSON -- написали aiorest поверх aiohttp.

Тогда же, весной 2014, начали контрибутить в aiohttp client понемногу.

Другие люди подключились (спасибо вам всем).

Добавилась поддержка unix sockets и http proxies в aiohttp.client, появился connector.

И, главное, люди начали использовать aiohttp хотя бы как asyncio HTTP
client -- это уже здорово.

-----------------------------------------------------

За лето более или менее сформировалось такое положение вещей:

Клиентская часть aiohttp довольно хороша (там есть что улучшать но уже
можно рекомендовать к использованию "простому программисту" -- и они
таки используют, судя по вопросам на stackoeverwlow).

На сервере мы имеем страшный aiohttp.server и aiorest с множеством
родовых травм (он вообще принимает только json если кто забыл и в
принципе не умеет быть нормальным сервером отдающим html, обрабатывать
web sockets и file uploads).

Необходимость перемен была очевидна: нужно взять лучшее из aiorest и влить это в aiohttp.

На то время мы с Кимом уже в приципе договорились, что так делать надо.

Вопрос, как всегда, в деталях и времени.

А, тем временем, появились aiozmq, aiopg, aioes, aioredis.


-----------------------------------------------------------

Благодаря невероятно щедрому предложению от KeepSafe (где Ким
работает) я получил возможность слетать в Сан-Франциско и посвятить
развитию aiohttp две недели.

Наверное, самый продуктивный отпуск в моей жизни.

Это было очень здорово -- писать и сразу же обсуждать написанное с Кимом без email и skype.

Было очень много сложных технических моментов, к решению которых без
личного общения мы бы шли очень долго.

В результате родился aiohttp.web.

И, самое главное, нам теперь гораздо легче делать новое.

--------------------------------------------------------

Библиотека должна быть простой, быстрой и дуракоустойчивой.

Без работы бок-о-бок трудно понять что коллега именно имеет в виду,
где у него принципиальные возражения а где то на что он готов
согласиться после аргументированного ответа.

С Алексеем Поправка мы работаем вместе, нам гораздо проще понимать
друг друга -- а временами и спорили очень даже серьезно.

Визит в KeepSafe помог мне понять как думает Ким, в чем-то убедить его а в другом изменить своё собственное мнение.

---------------------------------------------------------------------


Результат -- aiohttp.web

С web-sockets, streaming and middlewares.






---------------------------




Кстати, почему tulip? Просто ван Россум решил, что названия успешных асинхронных библиотек должны начинаться с буквы 't': те же tornado и twisted...

Потом оказалось, что на PyPI уже есть (никому не нужная, ни разу не асинхронная, но занявшее имя) библиотека tulip -- и проект пришлось переименовать.

